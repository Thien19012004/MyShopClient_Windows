<Page
    x:Class="MyShopClient.Views.OrderPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:viewmodels="using:MyShopClient.ViewModels"
    xmlns:models="using:MyShopClient.Models"
    xmlns:helpers="using:MyShopClient.Helpers"
    mc:Ignorable="d"
    d:DataContext="{d:DesignInstance Type=viewmodels:OrderListViewModel}">

    <!-- GRID Gá»C: khÃ´ng cÃ³ RowDefinitions, cÃ¡c con sáº½ chá»“ng lÃªn nhau -->
    <Grid Background="#FFF5F5F7">

        <!-- ================== MAIN CONTENT ================== -->
        <Grid Padding="24">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
            </Grid.RowDefinitions>

            <!-- Title -->
            <TextBlock Text="Orders"
                       FontSize="24"
                       FontWeight="SemiBold"
                       Grid.Row="0"/>

            <!-- Summary cards + filters -->
            <StackPanel Grid.Row="1" Margin="0,16,0,16" Spacing="12">

                <!-- Summary -->
                <StackPanel Orientation="Horizontal" Spacing="12">
                    <Border Background="White" CornerRadius="12" Padding="16" Width="200">
                        <StackPanel>
                            <TextBlock Text="Orders (page)" FontWeight="SemiBold"/>
                            <TextBlock Text="{Binding TotalOrdersOnPage}" FontSize="24" FontWeight="Bold"/>
                        </StackPanel>
                    </Border>

                    <Border Background="White" CornerRadius="12" Padding="16" Width="200">
                        <StackPanel>
                            <TextBlock Text="Paid (page)" FontWeight="SemiBold"/>
                            <TextBlock Text="{Binding TotalPaidOnPage}" FontSize="24" FontWeight="Bold"/>
                        </StackPanel>
                    </Border>

                    <Border Background="White" CornerRadius="12" Padding="16" Width="200">
                        <StackPanel>
                            <TextBlock Text="Amount (page)" FontWeight="SemiBold"/>
                            <TextBlock>
                                <Run Text="{Binding TotalAmountOnPage}"/>
                                <Run Text=" Ä‘"/>
                            </TextBlock>
                        </StackPanel>
                    </Border>
                </StackPanel>

                <!-- Filters -->
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>

                    <!-- Status -->
                    <StackPanel Orientation="Horizontal" Spacing="8" Grid.Column="0" Margin="0,0,16,0">
                        <TextBlock Text="Status:" VerticalAlignment="Center" Width="50"/>
                        <ComboBox ItemsSource="{Binding StatusOptions}"
                                  SelectedItem="{Binding SelectedStatus, Mode=TwoWay}"
                                  Width="140"
                                  VerticalAlignment="Center"/>
                    </StackPanel>

                    <!-- CustomerId -->
                    <StackPanel Orientation="Horizontal" Spacing="8" Grid.Column="1" Margin="0,0,16,0">
                        <TextBlock Text="CustomerId:" VerticalAlignment="Center" Width="80"/>
                        <TextBox Width="100"
                                 VerticalAlignment="Center"
                                 Text="{Binding CustomerIdText, Mode=TwoWay}"/>
                    </StackPanel>

                    <!-- SaleId -->
                    <StackPanel Orientation="Horizontal" Spacing="8" Grid.Column="2" Margin="0,0,16,0">
                        <TextBlock Text="SaleId:" VerticalAlignment="Center" Width="50"/>
                        <TextBox Width="100"
                                 VerticalAlignment="Center"
                                 Text="{Binding SaleIdText, Mode=TwoWay}"/>
                    </StackPanel>

                    <!-- Date range -->
                    <StackPanel Orientation="Horizontal" Spacing="8" Grid.Column="3" Margin="0,0,16,0">
                        <TextBlock Text="Date:" VerticalAlignment="Center" Width="40"/>
                        <TextBox Width="120"
                                 PlaceholderText="From yyyy-MM-dd"
                                 VerticalAlignment="Center"
                                 Text="{Binding FromDateText, Mode=TwoWay}"/>
                        <TextBlock Text="-" VerticalAlignment="Center"/>
                        <TextBox Width="120"
                                 PlaceholderText="To yyyy-MM-dd"
                                 VerticalAlignment="Center"
                                 Text="{Binding ToDateText, Mode=TwoWay}"/>
                    </StackPanel>

                    <!-- Spacer -->
                    <Border Grid.Column="4"/>

                    <!-- Apply Button -->
                    <Button Grid.Column="5"
                            Content="Apply"
                            Margin="0,0,8,0"
                            VerticalAlignment="Center"
                            Command="{Binding ApplyFilterCommand}"/>

                    <!-- Add Order Button -->
                    <Button Grid.Column="6"
                            Content="+ Add Order"
                            VerticalAlignment="Center"
                            Command="{Binding OpenAddDialogCommand}">
                        <Button.Background>
                            <SolidColorBrush Color="#FF5D5FEF"/>
                        </Button.Background>
                        <Button.Foreground>
                            <SolidColorBrush Color="White"/>
                        </Button.Foreground>
                    </Button>
                </Grid>
            </StackPanel>

            <!-- List + error -->
            <Grid Grid.Row="2">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>

                <!-- Error -->
                <TextBlock Grid.Row="0"
                           Margin="0,0,0,4"
                           Text="{Binding ErrorMessage}"
                           Foreground="Red"
                           Visibility="{Binding HasError, Converter={StaticResource BooleanToVisibilityConverter}}"/>

                <!-- Header + List -->
                <Grid Grid.Row="1">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>

                    <!-- Header row -->
                    <Grid Grid.Row="0"
                          Background="#FFEDEEF2"
                          Padding="16,10"
                          CornerRadius="8,8,0,0">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="40"/>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="2*"/>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>

                        <CheckBox/>
                        <TextBlock Grid.Column="1" Text="Order" FontWeight="SemiBold"/>
                        <TextBlock Grid.Column="2" Text="Customer" FontWeight="SemiBold"/>
                        <TextBlock Grid.Column="3" Text="Created" FontWeight="SemiBold"/>
                        <TextBlock Grid.Column="4" Text="Status" FontWeight="SemiBold"/>
                        <TextBlock Grid.Column="5" Text="Total" FontWeight="SemiBold"/>
                        <TextBlock Grid.Column="6" Text="Action" FontWeight="SemiBold"/>
                    </Grid>

                    <!-- List -->
                    <ListView Grid.Row="1"
                              x:Name="OrderListView"
                              ItemsSource="{Binding Orders}"
                              Margin="0,-2,0,0"
                              Background="Transparent"
                              BorderThickness="0">
                        <ListView.ItemContainerStyle>
                            <Style TargetType="ListViewItem">
                                <Setter Property="Padding" Value="0"/>
                                <Setter Property="HorizontalContentAlignment" Value="Stretch"/>
                                <Setter Property="Background" Value="White"/>
                                <Setter Property="Margin" Value="0,1,0,0"/>
                            </Style>
                        </ListView.ItemContainerStyle>

                        <ListView.ItemTemplate>
                            <DataTemplate x:DataType="models:OrderListItemDto">
                                <Grid Padding="16,8">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="40"/>
                                        <!-- checkbox -->
                                        <ColumnDefinition Width="*"/>
                                        <!-- Order -->
                                        <ColumnDefinition Width="2*"/>
                                        <!-- Customer -->
                                        <ColumnDefinition Width="*"/>
                                        <!-- Created -->
                                        <ColumnDefinition Width="*"/>
                                        <!-- Status -->
                                        <ColumnDefinition Width="*"/>
                                        <!-- Total -->
                                        <ColumnDefinition Width="Auto"/>
                                        <!-- Action -->
                                    </Grid.ColumnDefinitions>

                                    <CheckBox/>

                                    <!-- Order number -->
                                    <StackPanel Grid.Column="1" Spacing="2">
                                        <TextBlock Text="{x:Bind helpers:FormatHelpers.FormatOrderId(OrderId)}"/>
                                    </StackPanel>

                                    <!-- Customer -->
                                    <TextBlock Grid.Column="2" Text="{x:Bind CustomerName}"/>

                                    <!-- Created at -->
                                    <TextBlock Grid.Column="3"
                                   Text="{x:Bind helpers:FormatHelpers.FormatOrderDate(CreatedAt)}"/>

                                                    <!-- Status badge -->
                                                    <Border Grid.Column="4"
                                            CornerRadius="12"
                                            Padding="8,2"
                                            HorizontalAlignment="Left"
                                            Background="#FFEFEFEF">
                                                                    <TextBlock Text="{x:Bind Status}"/>
                                                                </Border>

                                                                <!-- Total -->
                                        <TextBlock Grid.Column="5">
                                        <Run Text="{x:Bind TotalPrice}"/>
                                        <Run Text=" Ä‘"/>    
                                    </TextBlock>    

                                    <!-- Actions -->
                                    <StackPanel Grid.Column="6"
                                            Orientation="Horizontal"
                                            HorizontalAlignment="Right"
                                            Spacing="8">
                                            <Button Content="âœ"
                                            Width="28" Height="28" Padding="0"
                                            Command="{Binding DataContext.OpenEditDialogCommand, ElementName=OrderListView}"
                                            CommandParameter="{Binding}"/>
                                        <Button Content="ðŸ—‘"
                                            Width="28" Height="28" Padding="0"
                                            Command="{Binding DataContext.DeleteOrderCommand, ElementName=OrderListView}"
                                            CommandParameter="{Binding}"/>  
                                    </StackPanel>
                                </Grid>
                                        </DataTemplate>

                        </ListView.ItemTemplate>
                    </ListView>
                </Grid>

                <!-- Pagination -->
                <Grid Grid.Row="2" Margin="0,16,0,0">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>

                    <TextBlock VerticalAlignment="Center">
                        <Run Text="Total: "/>
                        <Run Text="{Binding TotalItems}"/>
                        <Run Text=" orders"/>
                    </TextBlock>

                    <StackPanel Grid.Column="1"
                                Orientation="Horizontal"
                                Spacing="6"
                                VerticalAlignment="Center">
                        <Button Content="Previous"
                                Command="{Binding PreviousPageCommand}"/>
                        <TextBlock Text="{Binding CurrentPage}" Margin="4,0"/>
                        <TextBlock Text="/"/>
                        <TextBlock Text="{Binding TotalPages}" Margin="0,0,4,0"/>
                        <Button Content="Next"
                                Command="{Binding NextPageCommand}"/>
                    </StackPanel>
                </Grid>
            </Grid>
        </Grid>

        <!-- ================== OVERLAY ADD ORDER ================== -->
        <Grid Background="#99000000"
              Visibility="{Binding IsAddDialogOpen, Converter={StaticResource BooleanToVisibilityConverter}}">
            <Border Width="560"
                    Background="White"
                    CornerRadius="16"
                    Padding="20"
                    HorizontalAlignment="Center"
                    VerticalAlignment="Center">
                <StackPanel Spacing="10">
                    <TextBlock Text="Add New Order"
                               FontSize="20"
                               FontWeight="SemiBold"/>

                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <TextBox Header="Customer Id"
                                 Width="200"
                                 Text="{Binding NewCustomerIdText, Mode=TwoWay}"/>
                        <TextBox Header="Sale Id"
                                 Width="200"
                                 Text="{Binding NewSaleIdText, Mode=TwoWay}"/>
                    </StackPanel>

                    <TextBlock Text="Items" FontWeight="SemiBold" Margin="0,8,0,0"/>

                    <ItemsControl ItemsSource="{Binding NewOrderItems}">
                        <ItemsControl.ItemTemplate>
                            <DataTemplate x:DataType="viewmodels:OrderItemInputVM">
                                <StackPanel Orientation="Horizontal" Spacing="8" Margin="0,4,0,0">
                                    <TextBox Header="Product Id"
                                             Width="120"
                                             Text="{x:Bind ProductId, Mode=TwoWay}"/>
                                    <TextBox Header="Qty"
                                             Width="80"
                                             Text="{x:Bind Quantity, Mode=TwoWay}"/>
                                    <Button Content="âˆ’"
                                            Width="32" Height="32"
                                            Command="{Binding DataContext.RemoveOrderItemRowCommand, ElementName=OrderListView}"
                                            CommandParameter="{Binding}"/>
                                </StackPanel>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>

                    <Button Content="+ Add item line"
                            HorizontalAlignment="Left"
                            Command="{Binding AddOrderItemRowCommand}"/>

                    <TextBlock Text="{Binding AddDialogError}"
                               Foreground="Red"
                               TextWrapping="Wrap"
                               Visibility="{Binding HasAddDialogError, Converter={StaticResource BooleanToVisibilityConverter}}"/>

                    <StackPanel Orientation="Horizontal"
                                HorizontalAlignment="Right"
                                Spacing="8">
                        <Button Content="Cancel"
                                Command="{Binding CancelAddDialogCommand}"/>
                        <Button Content="Create"
                                Command="{Binding ConfirmAddOrderCommand}"/>
                    </StackPanel>
                </StackPanel>
            </Border>
        </Grid>

        <!-- ================== OVERLAY EDIT ORDER ================== -->
        <Grid Background="#99000000"
              Visibility="{Binding IsEditDialogOpen, Converter={StaticResource BooleanToVisibilityConverter}}">
            <Border Width="420"
                    Background="White"
                    CornerRadius="16"
                    Padding="20"
                    HorizontalAlignment="Center"
                    VerticalAlignment="Center">
                <StackPanel Spacing="10">
                    <TextBlock Text="Edit Order"
                               FontSize="20"
                               FontWeight="SemiBold"/>

                    <TextBlock Text="{Binding EditCustomerName}"
                               FontWeight="SemiBold"/>

                    <TextBox Header="Order Id"
                             IsReadOnly="True"
                             Text="{Binding EditOrderId}"/>

                    <TextBox Header="Total Price"
                             IsReadOnly="True"
                             Text="{Binding EditTotalPrice}"/>

                    <ComboBox Header="Status"
                              ItemsSource="{Binding StatusOptions}"
                              SelectedItem="{Binding EditStatus, Mode=TwoWay}"/>

                    <TextBlock Text="{Binding EditDialogError}"
                               Foreground="Red"
                               Visibility="{Binding HasEditDialogError, Converter={StaticResource BooleanToVisibilityConverter}}"/>

                    <StackPanel Orientation="Horizontal"
                                HorizontalAlignment="Right"
                                Spacing="8">
                        <Button Content="Cancel"
                                Command="{Binding CancelEditDialogCommand}"/>
                        <Button Content="Save"
                                Command="{Binding ConfirmEditOrderCommand}"/>
                    </StackPanel>
                </StackPanel>
            </Border>
        </Grid>

    </Grid>
</Page>
