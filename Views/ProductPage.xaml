<Page
    x:Class="MyShopClient.Views.ProductPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:models="using:MyShopClient.Models"
    xmlns:viewmodels="using:MyShopClient.ViewModels"
    xmlns:controls="using:MyShopClient.Controls"
    d:DataContext="{d:DesignInstance Type=viewmodels:ProductListViewModel}"
    mc:Ignorable="d"
    Background="#FFF5F5F7">

    <Grid Padding="24">

        <!-- ================= MAIN CONTENT ================= -->
        <Grid x:Name="MainContent">
  <Grid.RowDefinitions>
     <RowDefinition Height="Auto" />
           <RowDefinition Height="Auto" />
           <RowDefinition Height="Auto" />
     <RowDefinition Height="*" />
        <RowDefinition Height="Auto" />
    </Grid.RowDefinitions>

  <!-- Top bar: Title -->
  <TextBlock Grid.Row="0"
             Text="Product"
             FontSize="24"
             FontWeight="SemiBold"
             VerticalAlignment="Center" />

<!-- Search + Import + Add -->
            <Grid Grid.Row="1" Margin="0,16,0,16">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="Auto" />
                </Grid.ColumnDefinitions>

                <!-- Search box + Selected summary -->
                <StackPanel Grid.Column="0" Spacing="8">
                <!-- Selected Count card (visible when any product selected) -->
                <Border Background="#FF5D5FEF" CornerRadius="12" Padding="12" Width="220"
                        Visibility="{Binding HasSelectedProducts, Converter={StaticResource BooleanToVisibilityConverter}}">
                    <StackPanel>
                        <TextBlock Text="Selected" FontWeight="SemiBold" Foreground="White"/>
                        <TextBlock Text="{Binding SelectedProductsCount}" FontSize="20" FontWeight="Bold" Foreground="White"/>
                    </StackPanel>
                </Border>

                <Border
                        Background="White"
                        CornerRadius="20"
                        Height="40"
                        Padding="12,0">
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto" />
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="Auto" />
                        </Grid.ColumnDefinitions>

                        <TextBlock Text="ðŸ”"
                                   VerticalAlignment="Center"
                                   Margin="0,0,8,0" />

                        <TextBox Grid.Column="1"
                                 x:Name="SearchTextBox"
                                 BorderThickness="0"
                                 Background="Transparent"
                                 PlaceholderText="Search product..."
                                 Text="{Binding SearchText, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" />

                        <Button Grid.Column="2"
                                Content="Search"
                                Command="{Binding SearchCommand}" />
                    </Grid>
                </Border>
                </StackPanel>

                <!-- Import (mock) -->
                <Button Grid.Column="1"
                        x:Name="ImportButton"
                        Content="Import"
                        Height="40"
                        Margin="12,0,0,0"
                        Padding="16,0"
                        CornerRadius="20"
                        Click="ImportButton_Click" />

                <!-- Add Item -->
                <StackPanel Grid.Column="2" Orientation="Horizontal" Spacing="8">
                <Button x:Name="AddProductButton"
                        Content="+ Add Item (mock)"
                        Height="40"
                        Margin="12,0,0,0"
                        Padding="16,0"
                        CornerRadius="20"
                        Command="{Binding AddProductCommand}">
                    <Button.Background>
                        <SolidColorBrush Color="#FF5D5FEF" />
                    </Button.Background>
                    <Button.Foreground>
                        <SolidColorBrush Color="White" />
                    </Button.Foreground>
                </Button>

                <Button Content="ðŸ—‘ Delete"
                        Height="40"
                        Margin="12,0,0,0"
                        Padding="12,0"
                        CornerRadius="20"
                        Command="{Binding OpenBulkDeleteConfirmCommand}"
                        IsEnabled="{Binding HasSelectedProducts}">
                    <Button.Background>
                        <SolidColorBrush Color="#FFF44336" />
                    </Button.Background>
                    <Button.Foreground>
                        <SolidColorBrush Color="White" />
                    </Button.Foreground>
                </Button>

                <TextBlock VerticalAlignment="Center" Margin="12,0,0,0" Text="Selected:"/>
                <TextBlock VerticalAlignment="Center" Margin="4,0,0,0" Text="{Binding SelectedProductsCount}" FontWeight="Bold"/>
                </StackPanel>
            </Grid>

            <!-- Filter + Sort -->
            <Grid Grid.Row="2" Margin="0,0,0,12">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="2*" />
                    <ColumnDefinition Width="2*" />
                    <ColumnDefinition Width="2*" />
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="Auto" />
                </Grid.ColumnDefinitions>

                <!-- Category -->
                <StackPanel Grid.Column="0" Orientation="Horizontal" Spacing="8">
                    <TextBlock Text="Category:" VerticalAlignment="Center" />
                    <ComboBox ItemsSource="{Binding Categories}"
                              SelectedItem="{Binding SelectedCategory, Mode=TwoWay}"
                              DisplayMemberPath="Name"
                              Width="180" />
                </StackPanel>

                <!-- Price range -->
                <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="4">
                    <TextBlock Text="Price:" VerticalAlignment="Center" />
                    <TextBox Text="{Binding MinPriceText, Mode=TwoWay}"
                             Width="80"
                             PlaceholderText="Min" />
                    <TextBlock Text="-" VerticalAlignment="Center" />
                    <TextBox Text="{Binding MaxPriceText, Mode=TwoWay}"
                             Width="80"
                             PlaceholderText="Max" />
                </StackPanel>

                <!-- Sort -->
                <StackPanel Grid.Column="2" Orientation="Horizontal" Spacing="8">
                    <TextBlock Text="Sort:" VerticalAlignment="Center" />
                    <ComboBox ItemsSource="{Binding SortOptions}"
                              SelectedItem="{Binding SelectedSortOption, Mode=TwoWay}"
                              Width="150" />
                </StackPanel>

                <Button Grid.Column="3"
                        Content="Apply"
                        Margin="12,0,0,0"
                        Command="{Binding ApplyFilterCommand}" />

                <Button Grid.Column="4"
                        Content="Manage Categories"
                        Margin="12,0,0,0"
                        Command="{Binding OpenCategoryDialogCommand}" />    

            </Grid>

            <!-- Error message -->
            <TextBlock Grid.Row="3"
                       Margin="0,0,0,4"
                       Text="{Binding ErrorMessage}"
                       Foreground="Red"
                       Visibility="{Binding HasError,
                                            Converter={StaticResource BooleanToVisibilityConverter}}" />

            <!-- Header + List -->
            <Grid Grid.Row="3" Margin="0,20,0,0">
       <Grid.RowDefinitions>
        <RowDefinition Height="Auto" />
          <RowDefinition Height="*" />
  </Grid.RowDefinitions>

 <!-- Header row -->
     <Grid Grid.Row="0"
            Background="#FFEDEEF2"
       Padding="16,10"
      CornerRadius="8,8,0,0">
        <Grid.ColumnDefinitions>
          <ColumnDefinition Width="40" />
          <ColumnDefinition Width="150" />
          <ColumnDefinition Width="3*" />
        <ColumnDefinition Width="2*" />
   <ColumnDefinition Width="*" />
    <ColumnDefinition Width="*" />
             <ColumnDefinition Width="Auto" />
   </Grid.ColumnDefinitions>

   <controls:BlueCheckBox x:Name="SelectAllProductCheckBox" Click="SelectAllProductCheckBox_Click"/>

     <TextBlock Grid.Column="1" Text="Image" FontWeight="SemiBold" />
            <TextBlock Grid.Column="2" Text="Name" FontWeight="SemiBold" />
    <TextBlock Grid.Column="3" Text="Category" FontWeight="SemiBold"  />
        <TextBlock Grid.Column="4" Text="Stock" FontWeight="SemiBold"  />
        <TextBlock Grid.Column="5" Text="Price" FontWeight="SemiBold"/>
          <TextBlock Grid.Column="6" Text="Actions" FontWeight="SemiBold" />
 </Grid>

   <!-- Items -->
       <ListView Grid.Row="1"
    x:Name="ProductListView"
   ItemsSource="{Binding Products}"
   Margin="0,-2,0,0"
 Background="Transparent"
        BorderThickness="0"
     IsItemClickEnabled="False">
      <ListView.ItemContainerStyle>
 <Style TargetType="ListViewItem">
       <Setter Property="Padding" Value="0" />
    <Setter Property="HorizontalContentAlignment" Value="Stretch" />
        <Setter Property="Background" Value="White" />
    <Setter Property="Margin" Value="0,1,0,0" />
   </Style>
      </ListView.ItemContainerStyle>

         <ListView.ItemTemplate>
      <DataTemplate x:DataType="models:ProductItemDto">
     <Grid Padding="16,8">
  <Grid.ColumnDefinitions>
       <ColumnDefinition Width="40" />
  <ColumnDefinition Width="150" />
  <ColumnDefinition Width="3*" />
    <ColumnDefinition Width="2*" />
 <ColumnDefinition Width="*" />
   <ColumnDefinition Width="*" />
 <ColumnDefinition Width="Auto" />
   </Grid.ColumnDefinitions>

  <controls:BlueCheckBox IsChecked="{x:Bind IsSelected, Mode=TwoWay}"/>

     <!-- Multiple Product Images - Fixed Width with Clipping -->
 <Border Grid.Column="1" 
 Width="150"
    Height="44"
 HorizontalAlignment="Left">
  <Border.Clip>
  <RectangleGeometry Rect="0,0,150,44" />
   </Border.Clip>
  <StackPanel Orientation="Horizontal" 
  Spacing="4">
 <!-- Image 1: Always show if exists -->
     <Border Width="40" Height="40" 
   CornerRadius="4"
    Background="#FFF0F0F0"
Visibility="{Binding ImagePaths, Converter={StaticResource CollectionHasItemsConverter}, ConverterParameter=0}">
  <Image Stretch="UniformToFill">
     <Image.Source>
         <BitmapImage UriSource="{Binding ImagePaths, Converter={StaticResource ImageAtIndexConverter}, ConverterParameter=0}" />
        </Image.Source>
   </Image>
       </Border>

 <!-- Image 2: Always show if exists -->
   <Border Width="40" Height="40" 
 CornerRadius="4"
 Background="#FFF0F0F0"
      Visibility="{Binding ImagePaths, Converter={StaticResource CollectionHasItemsConverter}, ConverterParameter=1}">
    <Image Stretch="UniformToFill">
   <Image.Source>
  <BitmapImage UriSource="{Binding ImagePaths, Converter={StaticResource ImageAtIndexConverter}, ConverterParameter=1}" />
     </Image.Source>
  </Image>
      </Border>

   <!-- Image 3: Only show if count is exactly 3 (NOT more than 3) -->
       <Border Width="40" Height="40" 
  CornerRadius="4"
      Background="#FFF0F0F0"
  Visibility="{Binding ImagePaths, Converter={StaticResource CollectionHasExactlyConverter}, ConverterParameter=3}">
       <Image Stretch="UniformToFill">
      <Image.Source>
  <BitmapImage UriSource="{Binding ImagePaths, Converter={StaticResource ImageAtIndexConverter}, ConverterParameter=2}" />
   </Image.Source>
  </Image>
    </Border>

    <!-- More indicator: Show when count > 3 -->
    <Border Width="40" Height="40"
   CornerRadius="4"
        Background="#FFE0E0E0"
    Visibility="{Binding ImagePaths, Converter={StaticResource HasMoreThanConverter}, ConverterParameter=3}">
  <TextBlock Text="..."
        FontSize="18"
      FontWeight="Bold"
     HorizontalAlignment="Center"
            VerticalAlignment="Center"
     Foreground="#FF666666" />
            </Border>
 </StackPanel>
 </Border>

        <StackPanel Grid.Column="2" Spacing="2">
    <TextBlock Text="{x:Bind Name}" />
        <TextBlock Text="{x:Bind Sku}"
  FontSize="11"
Opacity="0.6" />
      </StackPanel>

        <TextBlock Grid.Column="3" Text="{x:Bind CategoryName}" />
   <TextBlock Grid.Column="4" Text="{x:Bind StockQuantity}" />
            <TextBlock Grid.Column="5" Text="{x:Bind SalePrice}" />

     <StackPanel Grid.Column="6"
       Orientation="Horizontal"
    HorizontalAlignment="Right"
      Spacing="8">
        <Button Content="ðŸ‘"
     Width="28" Height="28" Padding="0"
          Command="{Binding DataContext.ViewProductCommand, ElementName=ProductListView}"
        CommandParameter="{Binding}" />
      <Button Content="âœ"
 Width="28" Height="28" Padding="0"
     Command="{Binding DataContext.EditProductCommand, ElementName=ProductListView}"
      CommandParameter="{Binding}" />
 <Button Content="ðŸ—‘"
   Width="28" Height="28" Padding="0"
         Command="{Binding DataContext.OpenDeleteConfirmCommand, ElementName=ProductListView}"
 CommandParameter="{Binding}" />
      </StackPanel>
   </Grid>
            </DataTemplate>
           </ListView.ItemTemplate>
  </ListView>
      </Grid>

            <!-- Pagination -->
            <Grid Grid.Row="4"
                  Margin="0,16,0,0">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="Auto" />
                </Grid.ColumnDefinitions>

                <TextBlock VerticalAlignment="Center">
                    <Run Text="Total: " />
                    <Run Text="{Binding TotalItems}" />
                    <Run Text=" items" />
                </TextBlock>

                <StackPanel Grid.Column="1"
                            Orientation="Horizontal"
                            Spacing="6"
                            VerticalAlignment="Center">

                    <Button Content="Previous"
                            Command="{Binding PreviousPageCommand}" />

                    <TextBlock Text="{Binding CurrentPage}" Margin="4,0" />
                    <TextBlock Text="/" />
                    <TextBlock Text="{Binding TotalPages}" Margin="0,0,4,0" />

                    <Button Content="Next"
                            Command="{Binding NextPageCommand}" />
                </StackPanel>
            </Grid>
        </Grid>

        <!-- ================= OVERLAY ADD PRODUCT ================= -->
      <Grid x:Name="AddProductOverlay" Visibility="{Binding Dialogs.AddVm.IsOpen, Converter={StaticResource BooleanToVisibilityConverter}}">
       <Grid.Background>
  <SolidColorBrush Color="Black" Opacity="0.6"/>
       </Grid.Background>
   <Border Width="600"
    MaxHeight="700"
    Padding="20"
Background="White"
CornerRadius="16"
          HorizontalAlignment="Center"
           VerticalAlignment="Center">
                <ScrollViewer VerticalScrollBarVisibility="Auto">
      <StackPanel Spacing="12">
        <TextBlock Text="Add New Product"
      FontSize="20"
  FontWeight="SemiBold"
   Margin="0,0,0,8"/>

    <TextBox Header="SKU"
   Text="{Binding Dialogs.AddVm.Sku, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"/>

      <TextBox Header="Name"
                   Text="{Binding Dialogs.AddVm.Name, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"/>

    <StackPanel Orientation="Horizontal" Spacing="8">
           <TextBox Width="250"
   Header="Import Price"
             Text="{Binding Dialogs.AddVm.ImportPriceText, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"/>

    <TextBox Width="250"
       Header="Sale Price"
           Text="{Binding Dialogs.AddVm.SalePriceText, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"/>
        </StackPanel>

  <TextBox Header="Stock Quantity"
         Text="{Binding Dialogs.AddVm.StockQuantityText, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"/>

       <ComboBox Header="Category"
     ItemsSource="{Binding Categories}"
        SelectedItem="{Binding Dialogs.AddVm.Category, Mode=TwoWay}">
           <ComboBox.ItemTemplate>
    <DataTemplate>
 <TextBlock Text="{Binding Name}"/>
        </DataTemplate>
     </ComboBox.ItemTemplate>
      </ComboBox>

          <TextBox Header="Description"
 Text="{Binding Dialogs.AddVm.Description, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
          TextWrapping="Wrap"
        AcceptsReturn="True"
       Height="80"/>

   <!-- Product Images Section -->
     <StackPanel Spacing="8">
     <TextBlock Text="Product Images" FontWeight="SemiBold" />
            
   <!-- Image upload controls -->
   <StackPanel Orientation="Horizontal" Spacing="8">
         <TextBox Width="300"
             PlaceholderText="Image URL"
   Text="{Binding Dialogs.AddVm.ImagePath, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"/>

         <Button Content="Add URL"
  Command="{Binding AddImageUrlToNewProductCommand}" />
 
           <Button Content="ðŸ“ Upload"
     x:Name="AddUploadImageButton"
   Click="AddUploadImageButton_Click" />
      
   <!-- TEST button -->
          <Button Content="ðŸ§ª Test"
        Command="{Binding AddTestImageCommand}"
     ToolTipService.ToolTip="Add test image to verify binding"
       Background="Orange"
   Foreground="White" />
      </StackPanel>

       <!-- Image list -->
       <ItemsControl ItemsSource="{Binding NewProductImages}">
  <ItemsControl.ItemTemplate>
       <DataTemplate x:DataType="models:ProductImageItem">
<Border Background="#FFF5F5F5"
      Padding="8"
     Margin="0,4"
       CornerRadius="4">
  <Grid>
   <Grid.ColumnDefinitions>
            <ColumnDefinition Width="50" />
     <ColumnDefinition Width="*" />
<ColumnDefinition Width="Auto" />
       </Grid.ColumnDefinitions>

           <!-- Image preview with loading -->
     <Border Width="50" Height="50" CornerRadius="4" Background="#FFE0E0E0">
    <Grid>
             <Image Stretch="UniformToFill">
    <Image.Source>
  <BitmapImage UriSource="{Binding Url, Mode=OneWay, Converter={StaticResource SafeUriConverter}}" />
           </Image.Source>
     </Image>
           
   <!-- Loading indicator -->
        <ProgressRing IsActive="{Binding IsUploading, Mode=OneWay}"
      Width="30"
           Height="30"
        Visibility="{Binding IsUploading, Mode=OneWay, Converter={StaticResource BooleanToVisibilityConverter}}" />
   </Grid>
   </Border>

 <!-- URL text with error -->
      <StackPanel Grid.Column="1" VerticalAlignment="Center" Margin="12,0">
  <TextBlock Text="{Binding Url, Mode=OneWay}"
  TextTrimming="CharacterEllipsis" />
           
  <!-- Error message -->
   <TextBlock Text="{Binding ErrorMessage, Mode=OneWay}"
    Foreground="Red"
   FontSize="11"
      Visibility="{Binding HasError, Mode=OneWay, Converter={StaticResource BooleanToVisibilityConverter}}" />
      </StackPanel>

     <!-- Delete button -->
        <Button Grid.Column="2"
         Content="ðŸ—‘"
     Width="32"
   Height="32"
    Padding="0"
       Command="{Binding DataContext.RemoveImageFromNewProductCommand, ElementName=AddProductOverlay}"
     CommandParameter="{Binding}"
      IsEnabled="{Binding IsDeleting, Mode=OneWay, Converter={StaticResource InverseBooleanConverter}}" />
  </Grid>
     </Border>
      </DataTemplate>
       </ItemsControl.ItemTemplate>
    </ItemsControl>
   </StackPanel>

   <TextBlock Text="{Binding Dialogs.AddVm.Error}"
     Foreground="Red"
              TextWrapping="Wrap"
               Visibility="{Binding Dialogs.AddVm.HasError,
        Converter={StaticResource BooleanToVisibilityConverter}}"/>

         <StackPanel Orientation="Horizontal"
         HorizontalAlignment="Right"
   Spacing="8"
           Margin="0,8,0,0">
 <Button Content="Cancel"
         Command="{Binding CancelAddDialogCommand}"/>

     <Button Content="Add"
   Command="{Binding ConfirmAddProductCommand}"/>
       </StackPanel>
           </StackPanel>
         </ScrollViewer>
  </Border>
        </Grid>

<!-- ================= OVERLAY EDIT PRODUCT ================= -->
        <Grid x:Name="EditProductOverlay" Visibility="{Binding Dialogs.EditVm.IsOpen, Converter={StaticResource BooleanToVisibilityConverter}}">
    <Grid.Background>
     <SolidColorBrush Color="Black" Opacity="0.6"/>
            </Grid.Background>
   <Border Width="600"
            MaxHeight="700"
           Padding="20"
             Background="White"
             CornerRadius="16"
         HorizontalAlignment="Center"
 VerticalAlignment="Center">
   <ScrollViewer VerticalScrollBarVisibility="Auto">
   <StackPanel Spacing="12">
  <TextBlock Text="Edit Product"
      FontSize="20"
   FontWeight="SemiBold"
       Margin="0,0,0,8"/>

 <!-- SKU: cho xem nhÆ°ng khÃ´ng sá»­a -->
         <TextBox Header="SKU"
    Text="{Binding Dialogs.EditVm.Sku}"
           IsReadOnly="True" />

            <TextBox Header="Name"
Text="{Binding Dialogs.EditVm.Name, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"/>

      <StackPanel Orientation="Horizontal" Spacing="8">
           <TextBox Width="250"
     Header="Import Price"
           Text="{Binding Dialogs.EditVm.ImportPriceText, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"/>
           <TextBox Width="250"
             Header="Sale Price"
            Text="{Binding Dialogs.EditVm.SalePriceText, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"/>
  </StackPanel>

           <TextBox Header="Stock Quantity"
             Text="{Binding Dialogs.EditVm.StockQuantityText, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"/>

          <ComboBox Header="Category"
          ItemsSource="{Binding Categories}"
       SelectedItem="{Binding Dialogs.EditVm.Category, Mode=TwoWay}">
    <ComboBox.ItemTemplate>
 <DataTemplate>
    <TextBlock Text="{Binding Name}"/>
      </DataTemplate>
   </ComboBox.ItemTemplate>
   </ComboBox>

   <TextBox Header="Description"
   Text="{Binding Dialogs.EditVm.Description, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
         TextWrapping="Wrap"
          AcceptsReturn="True"
   Height="80"/>

       <!-- Product Images Section -->
           <StackPanel Spacing="8">
   <TextBlock Text="Product Images" FontWeight="SemiBold" />
   
        <!-- Image upload controls -->
   <StackPanel Orientation="Horizontal" Spacing="8">
      <TextBox Width="350"
              PlaceholderText="Image URL"
           Text="{Binding Dialogs.EditVm.ImagePath, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"/>
          
        <Button Content="Add URL"
      Command="{Binding AddImageUrlToEditProductCommand}" />
 
                   <Button Content="ðŸ“ Upload"
        x:Name="EditUploadImageButton"
       Click="EditUploadImageButton_Click" />
            </StackPanel>

            <!-- Image list -->
         <ItemsControl ItemsSource="{Binding EditProductImages}">
       <ItemsControl.ItemTemplate>
 <DataTemplate x:DataType="models:ProductImageItem">
     <Border Background="#FFF5F5F5"
         Padding="8"
       Margin="0,4"
 CornerRadius="4">
          <Grid>
  <Grid.ColumnDefinitions>
     <ColumnDefinition Width="50" />
      <ColumnDefinition Width="*" />
  <ColumnDefinition Width="Auto" />
    </Grid.ColumnDefinitions>

      <!-- Image preview with loading -->
      <Border Width="50" Height="50" CornerRadius="4" Background="#FFE0E0E0">
  <Grid>
         <Image Stretch="UniformToFill">
         <Image.Source>
  <BitmapImage UriSource="{Binding Url, Mode=OneWay, Converter={StaticResource SafeUriConverter}}" />
   </Image.Source>
    </Image>
     
 <!-- Loading indicator -->
        <ProgressRing IsActive="{Binding IsUploading, Mode=OneWay}"
        Width="30"
Height="30"
  Visibility="{Binding IsUploading, Mode=OneWay, Converter={StaticResource BooleanToVisibilityConverter}}" />
      </Grid>
   </Border>

           <!-- URL text with error -->
        <StackPanel Grid.Column="1" VerticalAlignment="Center" Margin="12,0">
   <TextBlock Text="{Binding Url, Mode=OneWay}"
     TextTrimming="CharacterEllipsis" />
     
         <!-- Error message -->
        <TextBlock Text="{Binding ErrorMessage, Mode=OneWay}"
       Foreground="Red"
FontSize="11"
 Visibility="{Binding HasError, Mode=OneWay, Converter={StaticResource BooleanToVisibilityConverter}}" />
         </StackPanel>

      <!-- Delete button -->
  <Button Grid.Column="2"
   Content="ðŸ—‘"
            Width="32"
       Height="32"
             Padding="0"
                Command="{Binding DataContext.RemoveImageFromEditProductCommand, ElementName=EditProductOverlay}"
            CommandParameter="{Binding}"
   IsEnabled="{x:Bind IsDeleting, Mode=OneWay, Converter={StaticResource InverseBooleanConverter}}" />
        </Grid>
      </Border>
     </DataTemplate>
  </ItemsControl.ItemTemplate>
          </ItemsControl>
                </StackPanel>

    <TextBlock Text="{Binding Dialogs.EditVm.Error}"
       Foreground="Red"
           TextWrapping="Wrap"
           Visibility="{Binding Dialogs.EditVm.HasError,
      Converter={StaticResource BooleanToVisibilityConverter}}"/>

                 <StackPanel Orientation="Horizontal"
    HorizontalAlignment="Right"
       Spacing="8"
     Margin="0,8,0,0">
       <Button Content="Cancel"
              Command="{Binding CancelEditDialogCommand}"/>

     <Button Content="Save"
           Command="{Binding ConfirmEditProductCommand}"/>
        </StackPanel>
        </StackPanel>
       </ScrollViewer>
            </Border>
        </Grid>

        <!-- ================= OVERLAY MANAGE CATEGORIES ================= -->
        <Grid x:Name="ManageCategoryOverlay" Visibility="{Binding IsCategoryDialogOpen, Converter={StaticResource BooleanToVisibilityConverter}}">
            <Grid.Background>
      <SolidColorBrush Color="Black" Opacity="0.6"/>
    </Grid.Background>
            <Border Width="720"
            Padding="20"
            Background="White"
            CornerRadius="16"
            HorizontalAlignment="Center"
            VerticalAlignment="Center">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="2*" />
                        <ColumnDefinition Width="3*" />
                    </Grid.ColumnDefinitions>

                    <!-- Left: category list -->
                    <StackPanel Grid.Column="0" Spacing="8">
                        <TextBlock Text="Categories"
                           FontSize="18"
                           FontWeight="SemiBold" />

                        <TextBox PlaceholderText="Search category..."
                         Text="{Binding CategorySearchText, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" />

                        <Button Content="Search"
                        Margin="0,4,0,4"
                        Command="{Binding CategorySearchCommand}" />

                        <ListView ItemsSource="{Binding CategoryItems}"
                          SelectedItem="{Binding SelectedCategoryItem, Mode=TwoWay}"
                          Height="260">
                            <ListView.ItemTemplate>
                                <DataTemplate x:DataType="models:CategoryItemDto">
                                    <StackPanel Spacing="2">
                                        <TextBlock Text="{x:Bind Name}" FontWeight="SemiBold" />
                                        <TextBlock Text="{x:Bind Description}" FontSize="11" Opacity="0.7" />
                                        <TextBlock FontSize="11" Opacity="0.6">
                                    <Run Text="Products: "/>
                                    <Run Text="{x:Bind ProductCount}"/>
                                        </TextBlock>
                                    </StackPanel>
                                </DataTemplate>
                            </ListView.ItemTemplate>
                        </ListView>
                    </StackPanel>

                    <!-- Right: detail form -->
                    <StackPanel Grid.Column="1" Spacing="8" Margin="16,0,0,0">
                        <TextBlock Text="Category Detail"
                           FontSize="18"
                           FontWeight="SemiBold" />

                        <TextBox Header="Name"
                         Text="{Binding CategoryNameText, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" />

                        <TextBox Header="Description"
                         Text="{Binding CategoryDescriptionText, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                         TextWrapping="Wrap"
                         AcceptsReturn="True"
                         Height="80" />

                        <TextBlock Text="{Binding CategoryDialogError}"
                           Foreground="Red"
                           TextWrapping="Wrap"
                           Visibility="{Binding HasCategoryDialogError,
                                                Converter={StaticResource BooleanToVisibilityConverter}}" />

                        <StackPanel Orientation="Horizontal"
                            HorizontalAlignment="Right"
                            Spacing="8"
                            Margin="0,8,0,0">
                            <Button Content="New"
                            Command="{Binding NewCategoryCommand}" />

                            <Button Content="Delete"
                            Command="{Binding DeleteCategoryCommand}" />

                            <Button Content="Close"
                            Command="{Binding CloseCategoryDialogCommand}" />

                            <Button Content="Save"
                            Command="{Binding SaveCategoryCommand}" />
                        </StackPanel>
                    </StackPanel>
                </Grid>
            </Border>
        </Grid>

      <!-- ================= OVERLAY DELETE CONFIRM ================= -->
        <Grid x:Name="DeleteConfirmOverlay" Visibility="{Binding IsDeleteConfirmOpen, Converter={StaticResource BooleanToVisibilityConverter}}">
          <Grid.Background>
          <SolidColorBrush Color="Black" Opacity="0.6"/>
     </Grid.Background>
   <Border Width="420" Background="White" CornerRadius="16" Padding="20" HorizontalAlignment="Center" VerticalAlignment="Center">
 <StackPanel Spacing="12">
 <TextBlock Text="âš ï¸ Confirm Delete" FontSize="20" FontWeight="SemiBold" Foreground="#FFF44336"/>
 <TextBlock Text="{Binding DeleteConfirmMessage}" TextWrapping="Wrap" FontSize="14"/>
 <StackPanel Orientation="Horizontal" HorizontalAlignment="Right" Spacing="8">
 <Button Content="Cancel" Command="{Binding CancelDeleteConfirmCommand}"/>
 <Button Content="Delete" Command="{Binding ConfirmDeleteProductCommand}">
 <Button.Background>
 <SolidColorBrush Color="#FFF44336"/>
 </Button.Background>
 <Button.Foreground>
 <SolidColorBrush Color="White"/>
 </Button.Foreground>
 </Button>
 </StackPanel>
 </StackPanel>
 </Border>
 </Grid>

        <!-- ================== OVERLAY BULK DELETE CONFIRM ================== -->
    <Grid x:Name="BulkDeleteConfirmOverlay" Visibility="{Binding IsBulkDeleteConfirmOpen, Converter={StaticResource BooleanToVisibilityConverter}}">
     <Grid.Background>
         <SolidColorBrush Color="Black" Opacity="0.6"/>
            </Grid.Background>
      <Border Width="480" Background="White" CornerRadius="16" Padding="20" HorizontalAlignment="Center" VerticalAlignment="Center">
 <StackPanel Spacing="12">
 <TextBlock Text="âš ï¸ Confirm Bulk Delete" FontSize="20" FontWeight="SemiBold" Foreground="#FFF44336"/>
 <TextBlock Text="{Binding BulkDeleteConfirmMessage}" TextWrapping="Wrap" FontSize="14"/>
 <StackPanel Orientation="Horizontal" HorizontalAlignment="Right" Spacing="8">
 <Button Content="Cancel" Command="{Binding CancelBulkDeleteConfirmCommand}"/>
 <Button Content="Delete All" Command="{Binding ConfirmBulkDeleteCommand}">
 <Button.Background>
 <SolidColorBrush Color="#FFF44336"/>
 </Button.Background>
 <Button.Foreground>
 <SolidColorBrush Color="White"/>
 </Button.Foreground>
 </Button>
 </StackPanel>
 </StackPanel>
 </Border>
 </Grid>
    </Grid>
</Page>
